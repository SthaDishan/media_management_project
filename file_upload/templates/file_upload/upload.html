<!DOCTYPE html>
<html>
  <head>
    <title>File Upload</title>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/2.1.8/css/dataTables.dataTables.css"
    />

    <script src="https://cdn.datatables.net/2.1.8/js/dataTables.js"></script>
    <style>
      /* Previous styles remain the same */
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .message {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
        animation: fadeOut 5s forwards;
      }
      @keyframes fadeOut {
        0% {
          opacity: 1;
        }
        70% {
          opacity: 1;
        }
        100% {
          opacity: 0;
        }
      }
      .success {
        background-color: #dff0d8;
        color: #3c763d;
        border: 1px solid #d6e9c6;
      }
      .error {
        background-color: #f2dede;
        color: #a94442;
        border: 1px solid #ebccd1;
      }
      .file-list {
        margin-top: 20px;
      }
      .file-item {
        padding: 10px;
        border: 1px solid #ddd;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .upload-form {
        margin: 20px 0;
        padding: 20px;
        border: 2px dashed #ccc;
        border-radius: 4px;
      }
      .file-actions {
        display: flex;
        gap: 10px;
      }
      .delete-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
      }
      .delete-btn:hover {
        background-color: #c82333;
      }
      .download-btn {
        background-color: #007bff;
        color: white;
        text-decoration: none;
        padding: 5px 10px;
        border-radius: 4px;
      }
      .download-btn:hover {
        background-color: #0056b3;
      }
      .upload-btn {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin-top: 10px;
      }
      .upload-btn:hover {
        background-color: #218838;
      }
      .file-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .file-date {
        color: #666;
        font-size: 0.9em;
      }
      .file-input-container {
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .remove-file-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
      }
      .add-file-btn {
        background-color: rgb(145, 220, 53);
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
      }
      .file-inputs-wrapper {
        margin-bottom: 15px;
      }
      .selected-file-name {
        margin-left: 10px;
        font-size: 0.9em;
        color: #666;
      }
      .file-counter {
        margin-bottom: 10px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <h1>File Upload</h1>

    {% if messages %} {% for message in messages %}
    <div class="message {% if message.tags %}{{ message.tags }}{% endif %}">
      {{ message }}
    </div>
    {% endfor %} {% endif %}

    <div class="upload-form">
      <form method="post" enctype="multipart/form-data" id="uploadForm">
        {% csrf_token %}
        <div class="file-counter">
          Files selected: <span id="fileCount">0</span>/10
        </div>
        <div id="fileInputsContainer" class="file-inputs-wrapper"></div>
        <a class="add-file-btn" onclick="addNewFileInput()">Add File</a>
        <button type="submit" class="upload-btn" id="submitBtn" disabled>
          Upload Files
        </button>
      </form>
      <p>Supported formats: .mp3, .mp4, .jpeg, .png, .gif</p>
      <p>File size: 100KB - 10MB</p>
    </div>

    <div class="file-list">
      <h2>Uploaded Files</h2>
      <table id="filesTable" class="display" style="width: 100%">
        <a class="btn btn-sm btn-danger delete_all_btn d-none" href="/delete-all">Delete All</a>
        <thead>
          <tr>
            <th>
              <input
                type="checkbox"
                name="select_all_file"
                class="select_all_file"
              />
            </th>
            <th>File name</th>
            <th>Size</th>
            <th>Filetype</th>
            <th>Category</th>
            <th>Uploaded date</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          {% for file in files %} {% comment %}
          <div class="file-item">
            {% endcomment %} {% comment %}
            <div class="file-info">
              {% endcomment %}

              <tr>
                <td>
                  <span class="file-date"
                    ><input
                      type="checkbox"
                      name="select_file"
                      class="select_file"
                  /></span>
                </td>
                <td><span class="file-date">{{ file.name }}</span></td>
                <td>
                  <span class="file-date file-size">{{ file.size }}</span>
                </td>
                <td><span class="file-date">{{ file.file_type }}</span></td>
                <td><span class="file-date">{{ file.category }}</span></td>
                <td>
                  <span class="file-date"
                    >{{ file.upload_date|date:"F j, Y" }}</span
                  >
                </td>
                <td>
                  <div class="file-actions">
                    <a href="{{ file.file.url }}" class="download-btn" download
                      >Download</a
                    >
                    <form
                      method="post"
                      action="{% url 'delete_file' file.id %}"
                      style="display: inline"
                    >
                      {% csrf_token %}
                      <button
                        type="submit"
                        class="delete-btn"
                        onclick="return confirm('Are you sure you want to delete this file?')"
                      >
                        Delete
                      </button>
                    </form>
                  </div>
                </td>
              </tr>

              {% comment %}
            </div>
            {% endcomment %} {% comment %}
          </div>
          {% endcomment %} {% empty %}
          <p>No files uploaded yet.</p>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <script>
      let fileCount = 0;
      const maxFiles = 10;

      function handleFileSelect(input) {
        const container = input.parentElement;
        const fileName = input.files[0]?.name;

        if (fileName) {
          // Add the filename display
          let fileNameSpan = container.querySelector(".selected-file-name");
          if (!fileNameSpan) {
            fileNameSpan = document.createElement("span");
            fileNameSpan.className = "selected-file-name";
            container.appendChild(fileNameSpan);
          }
          fileNameSpan.textContent = fileName;

          // Add remove button if it doesn't exist
          if (!container.querySelector(".remove-file-btn")) {
            const removeBtn = document.createElement("button");
            removeBtn.type = "button";
            removeBtn.className = "remove-file-btn";
            removeBtn.textContent = "Remove";
            removeBtn.onclick = () => {
              fileCount--;
              updateFileCount();
              container.remove();

              checkSubmitButton();
            };
            container.appendChild(removeBtn);
          }

          // Increment file count
          fileCount++;
          updateFileCount();

          // Add new file input if we haven't reached the maximum
          if (fileCount < maxFiles) {
            //addNewFileInput();
          }
        }

        checkSubmitButton();
      }

      function addNewFileInput() {
        const container = document.createElement("div");
        container.className = "file-input-container";
        const addBtn = document.createElement("button");

        const input = document.createElement("input");
        input.type = "file";
        input.name = "files";
        input.multiple = true;
        input.accept = ".mp3,.mp4,.jpeg,.png,.gif";
        input.className = "file-input";
        input.onchange = () => handleFileSelect(input);

        container.appendChild(input);
        document.getElementById("fileInputsContainer").appendChild(container);
      }

      function updateFileCount() {
        document.getElementById("fileCount").textContent = fileCount;
      }

      function checkSubmitButton() {
        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = fileCount === 0;
      }

      // Initialize with only one file input
      document.addEventListener("DOMContentLoaded", function () {
        addNewFileInput();
        $("#filesTable").DataTable({
          columnDefs: [{ orderable: false, targets: [0] }],
        });

        Array.from(document.getElementsByClassName("file-size")).forEach(
          (e) => {
            e.textContent =
              (parseInt(e.textContent.trim()) / (1024 * 1024)).toFixed(2) +
              " MB";
          }
        );
      });

      $(".select_all_file").change(function () {
        if($(this).prop("checked") ){
            $('.delete_all_btn').removeClass('d-none');
            
        }
        else{
            $('.delete_all_btn').addClass('d-none');

        }
        let parentSelect = $(this).prop("checked"); 
        $("input:checkbox.select_file").prop("checked", parentSelect);
    });
    </script>
  </body>
</html>
